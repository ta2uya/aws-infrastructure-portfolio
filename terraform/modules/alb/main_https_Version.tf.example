# ============================================
# HTTPS対応版ALB設定
# ============================================
# 
# 本番環境でHTTPSを使用する場合のバージョン
# 使用する際は以下が必要
#   1. Route53でドメインを取得または登録
#   2. ACM（AWS Certificate Manager）でSSL証明書を発行
#   3. このファイルを main.tf にリネームまたは内容を統合
#
# ============================================

# ALB
resource "aws_lb" "main" {
  name               = "${var.project_name}-${var.environment}-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [var.security_group_id]
  subnets            = var.subnet_ids

  tags = {
    Name        = "${var.project_name}-${var.environment}-alb"
    Environment = var.environment
  }
}

# ターゲットグループ
resource "aws_lb_target_group" "main" {
  name     = "${var.project_name}-${var.environment}-tg"
  port     = 80
  protocol = "HTTP"
  vpc_id   = var.vpc_id

  health_check {
    enabled             = true
    healthy_threshold   = 2
    unhealthy_threshold = 2
    timeout             = 5
    interval            = 30
    path                = "/"
    matcher             = "200"
  }

  tags = {
    Name        = "${var.project_name}-${var.environment}-tg"
    Environment = var.environment
  }
}

# ターゲットグループへのEC2登録
resource "aws_lb_target_group_attachment" "main" {
  count            = length(var.target_instance_ids)
  target_group_arn = aws_lb_target_group.main.arn
  target_id        = var.target_instance_ids[count.index]
  port             = 80
}

# ============================================
# HTTPSリスナー（メイン）
# ============================================
resource "aws_lb_listener" "https" {
  load_balancer_arn = aws_lb.main.arn
  port              = "443"
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-TLS13-1-2-2021-06"
  certificate_arn   = var.acm_certificate_arn  # ACM証明書のARN

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.main.arn
  }
}

# ============================================
# HTTPリスナー（HTTPSへリダイレクト）
# ============================================
resource "aws_lb_listener" "http_redirect" {
  load_balancer_arn = aws_lb.main.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type = "redirect"

    redirect {
      port        = "443"
      protocol    = "HTTPS"
      status_code = "HTTP_301"
    }
  }
}

# ============================================
# 追加で必要な変数（variables.tfに追加）
# ============================================
# 
# variable "acm_certificate_arn" {
#   description = "ACM証明書のARN"
#   type        = string
# }
#
# ============================================

# ============================================
# ACM証明書の作成例
# ============================================
#
# Route53でドメインを管理している場合、DNS検証で証明書を自動発行可能。
#
# resource "aws_acm_certificate" "main" {
#   domain_name       = "example.com"
#   validation_method = "DNS"
#
#   subject_alternative_names = [
#     "*.example.com"  # ワイルドカード証明書
#   ]
#
#   lifecycle {
#     create_before_destroy = true
#   }
#
#   tags = {
#     Name        = "${var.project_name}-${var.environment}-cert"
#     Environment = var.environment
#   }
# }
#
# # Route53でDNS検証レコードを自動作成
# resource "aws_route53_record" "cert_validation" {
#   for_each = {
#     for dvo in aws_acm_certificate.main.domain_validation_options : dvo.domain_name => {
#       name   = dvo.resource_record_name
#       record = dvo.resource_record_value
#       type   = dvo.resource_record_type
#     }
#   }
#
#   allow_overwrite = true
#   name            = each.value.name
#   records         = [each.value.record]
#   ttl             = 60
#   type            = each.value.type
#   zone_id         = var.route53_zone_id
# }
#
# # 証明書の検証完了を待機
# resource "aws_acm_certificate_validation" "main" {
#   certificate_arn         = aws_acm_certificate.main.arn
#   validation_record_fqdns = [for record in aws_route53_record.cert_validation : record.fqdn]
# }
# ============================================